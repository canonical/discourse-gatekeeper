name: Integration Tests

on:
  pull_request:

jobs:
  integration-tests:
    uses: canonical/operator-workflows/.github/workflows/integration_test.yaml@main
    secrets: inherit
    with:
      pre-run-script: tests/integration/pre_run.sh
  self-tests:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: Prepare for action to run
        run: |
          echo "name: $(echo ${{ github.repository }} | sed 's:.*/::')-test" > metadata.yaml
          mkdir docs
          echo "placeholder content for testing, repository: ${{ github.repository }}, branch: ${{ github.head_ref }}, commit: ${{ github.sha }}, some uuid: $(uuidgen)" > docs/index.md
      - name: Self test
        id: selfTest
        uses: ./
        env:
          DISCOURSE_API_USERNAME: ${{ secrets.DISCOURSE_API_USERNAME }}
          DISCOURSE_API_KEY: ${{ secrets.DISCOURSE_API_KEY }}
        with:
          create_new_topic: true
          discourse_host: discourse.charmhub.io
      - name: Clean up
        env:
          DISCOURSE_API_USERNAME: ${{ secrets.DISCOURSE_API_USERNAME }}
          DISCOURSE_API_KEY: ${{ secrets.DISCOURSE_API_KEY }}
        run: |
          echo ${{ steps.selfTest.outputs.created_pages }}
          echo ${{ steps.selfTest.outputs.discourse_config }}
          sudo apt update && sudo apt install python3-pip
          pip3 install -r requirements.txt
          ./discourse_cleanup.py ${{ steps.selfTest.outputs.created_pages }} ${{ steps.selfTest.outputs.discourse_config }}
